@using System.Collections.Generic
@model System.Collections.Generic.List<Shinogi.Domain.Challenge>
@{
    var filesByChallenge = ViewData["FilesByChallenge"] as Dictionary<Guid, List<Shinogi.Domain.ChallengeFile>>
        ?? new Dictionary<Guid, List<Shinogi.Domain.ChallengeFile>>();
    var solvedChallenges = ViewData["SolvedChallenges"] as HashSet<Guid>
        ?? new HashSet<Guid>();
    var challengeStats = ViewData["ChallengeStats"] as Dictionary<Guid, (int, int)>
        ?? new Dictionary<Guid, (int, int)>();
    var userInstances = ViewData["UserInstances"] as Dictionary<Guid, Shinogi.Domain.ChallengeInstance>
        ?? new Dictionary<Guid, Shinogi.Domain.ChallengeInstance>();
}
<section>
    <h1>Challenges</h1>
    @if (Model.Count == 0)
    {
        <div class="coming-soon">Coming soon...</div>
    }
    else
    {
        <div class="cards">
        @foreach (var c in Model)
        {
            <article class="card">
                <header><h3>@c.Name</h3><span class="pill">@c.Category</span></header>
                <p>@c.Description</p>
                <div class="meta" style="color:var(--primary-muted); font-size:13px; margin-bottom:12px;">
                    @if (challengeStats.ContainsKey(c.Id))
                    {
                        var (currentValue, solveCount) = challengeStats[c.Id];
                        <text>ÁèæÂú®„ÅÆÁÇπÊï∞: @currentValue pt / Ëß£Á≠îÊ∏à„Åø: @solveCount „ÉÅ„Éº„É†</text>
                    }
                    else
                    {
                        <text>ÁèæÂú®„ÅÆÁÇπÊï∞: @c.ValueInitial pt / Ëß£Á≠îÊ∏à„Åø: 0 „ÉÅ„Éº„É†</text>
                    }
                </div>
                @if (filesByChallenge.ContainsKey(c.Id) && filesByChallenge[c.Id].Count > 0)
                {
                    <div style="margin-bottom:12px;">
                        <span style="color:var(--primary-muted); font-size:13px;">Files:</span>
                        @foreach (var f in filesByChallenge[c.Id])
                        {
                            <a asp-controller="Challenges" asp-action="DownloadFile" asp-route-id="@c.Id" asp-route-fileId="@f.Id"
                               style="display:inline-block; margin:2px 6px 2px 0; padding:4px 10px; background:var(--border); border-radius:6px; color:var(--primary-hover); font-size:12px; text-decoration:none;">
                                @f.OriginalName
                            </a>
                        }
                    </div>
                }
                @if (c.RequiresInstance && User.Identity != null && User.Identity.IsAuthenticated)
                {
                    @if (userInstances.ContainsKey(c.Id))
                    {
                        var instance = userInstances[c.Id];
                        var remaining = (instance.ExpiresAt - DateTimeOffset.UtcNow).TotalMinutes;
                        <div style="background:var(--card-bg); padding:12px; border-radius:6px; margin-bottom:12px; border:1px solid var(--primary);">
                            <strong style="color:var(--primary);">‚úì „Ç§„É≥„Çπ„Çø„É≥„ÇπËµ∑Âãï‰∏≠</strong><br>
                            <span style="font-size:13px;">URL: <a href="@instance.Url" target="_blank" style="color:var(--primary-hover);">@instance.Url</a></span><br>
                            <span style="font-size:13px;">ÊÆã„ÇäÊôÇÈñì: @((int)remaining) ÂàÜ</span><br>
                            <form method="post" asp-action="StopInstance" asp-route-id="@c.Id" style="margin-top:8px;">
                                <button type="submit" class="btn-danger" style="font-size:13px; padding:6px 12px;">ÂÅúÊ≠¢</button>
                            </form>
                        </div>
                    }
                    else
                    {
                        <form method="post" asp-action="StartInstance" asp-route-id="@c.Id" style="margin-bottom:12px;">
                            <button type="submit" style="width:100%;">üöÄ „Ç§„É≥„Çπ„Çø„É≥„Çπ„ÇíËµ∑Âãï</button>
                        </form>
                    }
                }
                @if (User.Identity != null && User.Identity.IsAuthenticated)
                {
                    var isSolved = solvedChallenges.Contains(c.Id);
                    <form method="post" asp-controller="Challenges" asp-action="Submit" asp-route-id="@c.Id" style="display:flex; gap:8px;">
                        <input name="flag" placeholder="@(isSolved ? "solved!" : "flag{...}")" required style="flex:1; padding:8px; border-radius:6px; border:1px solid var(--border); background:var(--surface-input); color:var(--text);" @(isSolved ? "disabled" : "") />
                        <button type="submit" @(isSolved ? "disabled" : "")>Submit</button>
                    </form>
                }
            </article>
        }
        </div>
    }
</section>
